{% extends 'base.html' %}

{% block title %}{{ title.title() }}{% endblock %}

{% block content %}
    <div class="row mb-3">
        <!-- START: Left block -->
        <div class="col-12 col-lg-9 d-flex justify-content-center mt-2">
            <div class="img-container">
                <img id="video_feed" class="text-center rounded" src="{{ url_for('get_frames', location=location) }}" alt=""/>
            </div>
        </div>
        <!-- END: Left block -->

        <!-- START: Right block -->
        <div class="col-12 col-lg-3">
            <div class="bg-warning text-dark rounded px-2 my-2 position-relative">
                <div class="h4 position-absolute">Кол-во: <span id="total_count">0</span></div>
                <div id="current_count" class="display-1 pt-3">0</div>
            </div>

            {% if(items is not none) %}
                <div class="border border-primary rounded mb-2 p-2">
                    <select class="selectpicker form-control" id="item" name="item" data-width="auto" data-style="btn-dark"
                            data-live-search="true">
                        <option selected>Выберите ПФ</option>
                        {% for item in items %}
                            <option value="{{ item.No_ }}">[{{ item.No_ }}] {{ item.Description }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            <div class="border border-danger-subtle rounded mb-2 p-2">
                <div class="col-12 mb-3">
                    <label for="defect_count" class="form-label h4">Брак</label>
                    <div class="input-group" id="defect_count">
                        <button class="btn btn-sm btn-secondary input-plus">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-plus-lg"
                                 viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                      d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"></path>
                            </svg>
                        </button>
                        <input type="number" class="form-control form-control-lg" aria-label="" name="defect_count"
                               value="0" min="0" max="999999" maxlength="9">
                        <button class="btn btn-sm btn-secondary input-minus">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-dash-lg"
                                 viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="col-12 keyboard keyboard-defect px-2" data-input-id="defect_count">
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="1">1</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="2">2</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="3">3</button>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="4">4</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="5">5</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="6">6</button>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="7">7</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="8">8</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="9">9</button>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="0">0</button>
                        <button class="btn btn-warning text-black col-4 m-1 reset text-truncate">Сбросить</button>
                    </div>
                </div>
            </div>

            <div class="border border-warning-subtle rounded mb-2 p-2">
                <div class="col-12 mb-3">
                    <label for="correct_count" class="form-label h4">Корректировка</label>
                    <button class="btn btn-outline-info float-end" data-bs-toggle="collapse" data-bs-target="#collapseСorrect"
                            aria-expanded="false" aria-controls="collapseСorrect"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"
                             class="bi bi-keyboard align-middle"
                             viewBox="0 0 16 16">
                            <path d="M14 5a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1zM2 4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                            <path d="M13 10.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm0-2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm-5 0A.25.25 0 0 1 8.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 8 8.75zm2 0a.25.25 0 0 1 .25-.25h1.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-1.5a.25.25 0 0 1-.25-.25zm1 2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm-5-2A.25.25 0 0 1 6.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 6 8.75zm-2 0A.25.25 0 0 1 4.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 4 8.75zm-2 0A.25.25 0 0 1 2.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 2 8.75zm11-2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm-2 0a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm-2 0A.25.25 0 0 1 9.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 9 6.75zm-2 0A.25.25 0 0 1 7.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 7 6.75zm-2 0A.25.25 0 0 1 5.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 5 6.75zm-3 0A.25.25 0 0 1 2.25 6h1.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-1.5A.25.25 0 0 1 2 6.75zm0 4a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm2 0a.25.25 0 0 1 .25-.25h5.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-5.5a.25.25 0 0 1-.25-.25z"/>
                        </svg>
                    </button>
                    <button class="btn btn-outline-danger float-end me-2" id="correct_clear"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-trash"
                             viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                        </svg>
                    </button>
                    <div class="input-group" id="correct_count">
                        <button class="btn btn-sm btn-secondary input-plus">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-plus-lg"
                                 viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                      d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"></path>
                            </svg>
                        </button>
                        <input type="number" class="form-control form-control-lg" aria-label="" name="correct_count"
                               value="0" maxlength="9">
                        <button class="btn btn-sm btn-secondary input-minus">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-dash-lg"
                                 viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="col-12 keyboard keyboard-correct px-2 collapse" data-input-id="correct_count" id="collapseСorrect">
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="1">1</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="2">2</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="3">3</button>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="4">4</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="5">5</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="6">6</button>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="7">7</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="8">8</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="9">9</button>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary col m-1 fs-5" data-value="-">+/-</button>
                        <button class="btn btn-secondary col m-1 fs-5" data-value="0">0</button>
                        <button class="btn btn-warning text-black col m-1 reset text-truncate">Сбросить</button>
                    </div>
                </div>
            </div>

            <div class="col-12 mb-3 px-2">
                <div class="row">
                    <button class="btn btn-primary col mb-3 m-1" id="btn_reset_current">Новая партия</button>
                </div>
                <div class="row">
                    <button class="btn btn-success col mb-3 m-1" id="btn_save">Сохранить</button>
                    <button class="btn btn-danger col mb-3 m-1" id="btn_reset">Сбросить</button>
                </div>
            </div>
        </div>
        <!-- END: Right block -->
    </div>
{% endblock %}

{% block footer %}
    <link href="{{ url_for('static', filename='assets/bootstrap-select-1.14/css/bootstrap-select.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='assets/bootstrap-select-1.14/js/bootstrap-select.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/bootstrap-select-1.14/js/i18n/defaults-ru_RU.min.js') }}"></script>

    <script>
        $(document).ready(function () {
            // Обработчик получения счетчика
            socket.on('{{ location }}_count', function (data) {
                if (data.total > 0) {
                    let defect_count = parseInt($("#defect_count input").val());
                    defect_count = defect_count > 0 ? defect_count : 0;

                    let correct_count = parseInt($("#correct_count input").val());
                    correct_count = !isNaN(correct_count) ? correct_count : 0;

                    let current_count = parseInt(data.current);
                    current_count = current_count > 0 ? current_count : 0;

                    let total_count = parseInt(data.total);
                    total_count = total_count > 0 ? total_count : 0;

                    $('#current_count').html(current_count);
                    $('#total_count').html(total_count - defect_count + correct_count);
                } else {
                    $('#current_count').html('0');
                    $('#total_count').html('0');
                }
            });

            // Обработчик получения уведомлений
            socket.on('{{ location }}_notification', function (data) {
                if (data.message.length > 0) {
                    showToast(data.message, data.type);
                }
            });

            //---------------------------------------------------------------------------
            // Bootstrap Select
            //---------------------------------------------------------------------------

            $('.selectpicker').selectpicker();

            //---------------------------------------------------------------------------
            // Keyboard
            //---------------------------------------------------------------------------

            $('.input-plus').on('click', function () {
                let $input = $(this).parent().find('input');
                let value = parseInt($input.val());
                let validate_value = true;
                if ($input.attr('max') !== undefined) {
                    validate_value = value < parseInt($input.attr('max'));
                }
                if (!isNaN(value) && validate_value) {
                    $input.val(value + 1);
                }
            });

            $('.input-minus').on('click', function () {
                let $input = $(this).parent().find('input');
                let value = parseInt($input.val());
                let validate_value = true;
                if ($input.attr('min') !== undefined) {
                    validate_value = value > parseInt($input.attr('min'));
                }
                if (!isNaN(value) && validate_value) {
                    $input.val(value - 1);
                }
            });

            $('#correct_clear').on('click', function () {
                $('#correct_count input').val(0);
            });

            $('.keyboard button').on('click', function () {
                let $this = $(this);
                let $input = $('#' + $this.parent().parent().data('input-id') + ' input');
                let value = $this.data('value');
                let input_val = $input.val();
                input_val = input_val.replace(/[^0-9\-]/g, '');

                if ($this.hasClass('reset')) {
                    $input.val(0);
                    return;
                }

                if (value === '-') {
                    input_val = -(input_val);
                } else {
                    input_val = input_val + value;
                }

                if (input_val > 999999 || input_val < -999999) {
                    return;
                }

                $input.val(parseInt(input_val));
            });

            //---------------------------------------------------------------------------
            // Form buttons
            //---------------------------------------------------------------------------

            $('#btn_save').on('click', function () {
                let correct_count = $('#correct_count input').val();
                let defect_count = $('#defect_count input').val();
                let item_no = $('#item').val();

                $.ajax({
                    url: '{{ url_for('save_count', location=location) }}',
                    method: 'post',
                    data: {
                        'item_no': item_no,
                        'correct_count': parseInt(correct_count),
                        'defect_count': parseInt(defect_count)
                    },
                    success: function (data) {
                        if (!data) {
                            data = 0;
                        }
                        $("#total_count").html(data.total_count);
                        $("#correct_count input").val(data.correct_count);
                        $("#defect_count input").val(data.defect_count);
                    }
                });
            });

            $('#btn_reset').on('click', function () {
                $.ajax({
                    url: '{{ url_for('reset_count', location=location) }}',
                    method: 'get',
                    data: {},
                    success: function (data) {
                        if (!data) {
                            data = 0;
                        }
                        $("#total_count").html(data.total_count);
                        $("#product_count input").val(data.total_count);
                        $("#defect_count input").val(data.defect_count);
                    }
                });
            });

            $('#btn_reset_current').on('click', function () {
                $.ajax({
                    url: '{{ url_for('reset_count_current', location=location) }}',
                    method: 'get',
                    data: {},
                    success: function (data) {
                        if (!data) {
                            data = 0;
                        }
                        $("#current_count").val(data.current_count);
                    }
                });
            });
        });
    </script>
{% endblock %}